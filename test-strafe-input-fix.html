<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strafe Input Fix - Manual Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            padding: 20px;
            background: #1a1a2e;
            color: white;
        }
        h1 { color: #4fc3f7; }
        .test-section {
            background: #2a2a4e;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        .status { margin: 10px 0; }
        .pass { color: #4fc3f7; }
        .fail { color: #ef5350; }
        .pending { color: #ffeb3b; }
        code {
            background: #333;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
        }
        button {
            background: #4fc3f7;
            color: black;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover { background: #81d4fa; }
        #log {
            background: #000;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            border-radius: 5px;
        }
        .iframe-container {
            position: relative;
            width: 100%;
            height: 400px;
            border: 2px solid #4fc3f7;
            border-radius: 10px;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <h1>Strafe Input Fix Verification Test</h1>

    <div class="test-section">
        <h2>Issue Description</h2>
        <p>User reported that strafe controls were NOT working during manual testing, but automated Puppeteer tests showed everything working perfectly (110 position updates, officer moves between lanes correctly).</p>
        <p><strong>Root Cause:</strong> Event listeners were attached to <code>document</code> instead of the canvas element, causing UI overlay elements to potentially intercept events.</p>
    </div>

    <div class="test-section">
        <h2>Fix Applied</h2>
        <ul>
            <li>Moved touch/mouse event listeners from <code>document</code> to <code>renderer.domElement</code> (the canvas)</li>
            <li>Added <code>e.stopPropagation()</code> to prevent event bubbling</li>
            <li>Added <code>touchmove</code> handler with <code>passive: false</code> to prevent browser gestures</li>
            <li>Set canvas <code>touchAction: 'none'</code> and <code>tabIndex: 1</code> for better event handling</li>
            <li>Canvas now has explicit ID <code>gameCanvas</code></li>
        </ul>
    </div>

    <div class="test-section">
        <h2>Manual Test Steps</h2>
        <ol>
            <li>Open the game in a new tab: <a href="index.html" target="_blank" style="color: #4fc3f7;">Open Game</a></li>
            <li>Open browser DevTools (F12) and go to Console tab</li>
            <li>Click "Shoot it Out" to start the shooting mode</li>
            <li>Try these controls:
                <ul>
                    <li><strong>Click LEFT side of screen</strong> - Officer should move left</li>
                    <li><strong>Click RIGHT side of screen</strong> - Officer should move right</li>
                    <li><strong>Press Arrow Left key</strong> - Officer should move left</li>
                    <li><strong>Press Arrow Right key</strong> - Officer should move right</li>
                </ul>
            </li>
            <li>Check console for logs like:
                <ul>
                    <li><code>Input system initialized! Event listeners attached to canvas: gameCanvas</code></li>
                    <li><code>Mouse DOWN on canvas: [x], [y]</code></li>
                    <li><code>Strafe LEFT/RIGHT to position: [0/1/2]</code></li>
                </ul>
            </li>
        </ol>
    </div>

    <div class="test-section">
        <h2>Verification Checklist</h2>
        <div class="status pending" id="status-canvas">[ ] Canvas has ID 'gameCanvas'</div>
        <div class="status pending" id="status-mouse">[ ] Mouse clicks trigger movement</div>
        <div class="status pending" id="status-touch">[ ] Touch events trigger movement (mobile/touch device)</div>
        <div class="status pending" id="status-keyboard">[ ] Keyboard arrows trigger movement</div>
        <div class="status pending" id="status-console">[ ] Console shows proper event logs</div>
    </div>

    <div class="test-section">
        <h2>Files Modified</h2>
        <ul>
            <li><code>/Users/paulbridges/stevo/game.js</code> - Input.init() method updated</li>
            <li><code>/Users/paulbridges/stevo/index.html</code> - Cache version bumped to v=20</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>Code Changes Summary</h2>
        <h3>Before (Broken):</h3>
        <pre style="background:#333;padding:10px;overflow-x:auto;">init() {
    document.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: false });
    document.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: false });
    document.addEventListener('mousedown', this.handleMouseDown.bind(this));
    document.addEventListener('mouseup', this.handleMouseUp.bind(this));
    document.addEventListener('keydown', this.handleKeyDown.bind(this));
}</pre>

        <h3>After (Fixed):</h3>
        <pre style="background:#333;padding:10px;overflow-x:auto;">init() {
    // CRITICAL FIX: Attach events to canvas element, not document
    this.canvas = renderer.domElement;
    this.canvas.id = 'gameCanvas';
    this.canvas.style.touchAction = 'none';

    // Touch events on canvas with passive: false
    this.canvas.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: false });
    this.canvas.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: false });
    this.canvas.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });

    // Mouse events on canvas
    this.canvas.addEventListener('mousedown', this.handleMouseDown.bind(this));
    this.canvas.addEventListener('mouseup', this.handleMouseUp.bind(this));

    // Keyboard events stay on document (required for key input without focus)
    document.addEventListener('keydown', this.handleKeyDown.bind(this));

    this.canvas.tabIndex = 1;
    this.canvas.style.outline = 'none';
}</pre>
    </div>

    <script>
        // This script is just for the test page UI
        document.querySelectorAll('.status').forEach(el => {
            el.style.cursor = 'pointer';
            el.addEventListener('click', function() {
                if (this.classList.contains('pending')) {
                    this.classList.remove('pending');
                    this.classList.add('pass');
                    this.textContent = this.textContent.replace('[ ]', '[X]');
                } else if (this.classList.contains('pass')) {
                    this.classList.remove('pass');
                    this.classList.add('fail');
                    this.textContent = this.textContent.replace('[X]', '[FAIL]');
                } else {
                    this.classList.remove('fail');
                    this.classList.add('pending');
                    this.textContent = this.textContent.replace('[FAIL]', '[ ]');
                }
            });
        });
    </script>
</body>
</html>
